<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDA MOVR Data Dictionary Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2c5aa0;
            margin-bottom: 10px;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #555;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .sidebar {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 60vh;
            overflow-y: auto;
            width: 200px;
            z-index: 100;
        }
        
        .sidebar h3 {
            margin-bottom: 10px;
            color: #2c5aa0;
            font-size: 14px;
        }
        
        .section-nav {
            list-style: none;
        }
        
        .section-nav li {
            margin-bottom: 5px;
        }
        
        .section-nav a {
            color: #666;
            text-decoration: none;
            font-size: 12px;
            display: block;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .section-nav a:hover {
            background-color: #e8f0fe;
            color: #2c5aa0;
        }
        
        .main-content {
            margin-left: 240px;
        }
        
        .form-section {
            background: white;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .form-header {
            background: #2c5aa0;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .section-group {
            border-left: 4px solid #4285f4;
            margin: 15px 20px;
            padding-left: 15px;
        }
        
        .section-title {
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .field-item {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            transition: box-shadow 0.2s;
        }
        
        .field-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .field-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .display-label {
            font-weight: 500;
            color: #333;
            flex: 1;
        }
        
        .tags {
            display: flex;
            gap: 6px;
            margin-left: 10px;
        }
        
        .tag {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .tag.dmd {
            background: #e8f5e8;
            color: #2e7d2e;
        }
        
        .tag.sma {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .tag.required {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .priority-control {
            margin-top: 8px;
            padding: 6px 0;
            border-top: 1px solid #e0e0e0;
        }
        
        .priority-label {
            font-size: 12px;
            font-weight: 500;
            color: #555;
            margin-bottom: 4px;
        }
        
        .priority-select {
            width: 100%;
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .priority-select option[value="high"] {
            background-color: #ffebee;
            color: #d32f2f;
            font-weight: bold;
        }
        
        .priority-select option[value="medium"] {
            background-color: #fff3e0;
            color: #f57c00;
            font-weight: bold;
        }
        
        .priority-select option[value="low"] {
            background-color: #e8f5e8;
            color: #388e3c;
            font-weight: bold;
        }
        
        .priority-select option[value="irrelevant"] {
            background-color: #f5f5f5;
            color: #757575;
            font-weight: bold;
        }
        
        .priority-select option[value="test"] {
            background-color: #ffffff;
            color: #9c27b0;
            font-weight: bold;
        }
        
        .priority-high { 
            border-left: 4px solid #d32f2f; 
            background-color: #ffebee;
        }
        .priority-medium { 
            border-left: 4px solid #f57c00; 
            background-color: #fff3e0;
        }
        .priority-low { 
            border-left: 4px solid #388e3c; 
            background-color: #e8f5e8;
        }
        .priority-irrelevant { 
            border-left: 4px solid #757575; 
            background-color: #f5f5f5;
        }
        .priority-test { 
            border-left: 4px solid #9c27b0; 
            background-color: #ffffff;
        }
        
        .submit-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .submit-btn {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .submit-btn:hover {
            background: #1e3f73;
        }
        
        .load-btn {
            background: #388e3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .load-btn:hover {
            background: #2e7d32;
        }
        
        .status-message {
            margin-top: 10px;
            padding: 8px 16px;
            border-radius: 4px;
            display: none;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d2e;
            border: 1px solid #c8e6c9;
        }
        
        .status-error {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }
        
        .field-details {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
        }
        
        .field-name {
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Wall -->
    <div id="login-wall" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; align-items:center; justify-content:center;">
        <div style="background:white; padding:2rem; border-radius:12px; max-width:500px; margin:20px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,0.3);">
            <div style="font-size:3rem; margin-bottom:1rem;">🔒</div>
            <h2 style="color:#dc2626; margin-bottom:1rem;">Authentication Required</h2>
            <p style="margin-bottom:1.5rem; color:#64748b;">
                This tool requires authentication. Please log in through the MOVR Data Hub portal first.
            </p>
            <div style="background:#f8fafc; padding:1rem; border-radius:6px; margin-bottom:1.5rem; text-align:left;">
                <strong style="color:#1e293b;">To access this tool:</strong><br>
                1. Go to the <a href="index.html" style="color:#2563eb;">MOVR Data Hub Portal</a><br>
                2. Log in with your credentials<br>
                3. Return to this page
            </div>
            <div style="display:flex; gap:1rem; justify-content:center; flex-wrap:wrap;">
                <a href="index.html" style="background:#2563eb; color:white; padding:12px 24px; border-radius:6px; text-decoration:none; font-weight:600;">
                    🔑 Go to Login Portal
                </a>
                <button onclick="checkAuthAgain()" style="background:transparent; color:#2563eb; border:2px solid #2563eb; padding:10px 22px; border-radius:6px; cursor:pointer; font-weight:600;">
                    🔄 Check Again
                </button>
            </div>
        </div>
    </div>

    <div id="password-lock" style="display:none; max-width:450px; margin:60px auto; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:32px 24px; text-align:center;">
        <h2 style="color:#2c5aa0;">Enhanced Access Available</h2>
        <p id="lock-message">While the Data Dictionary is viewable by everyone, enhanced features and additional viewers require authentication.</p>
        
        <div style="margin: 20px 0; padding: 15px; background: #f0f7ff; border-radius: 6px; font-size: 14px; text-align: left; border-left: 4px solid #2c5aa0;">
            <strong>� Enhanced Access Includes:</strong><br>
            • Vendor Mapping Viewer<br>
            • MOVR Data Hub Tools<br>
            • Priority Setting & Saving<br>
            • Advanced Export Options<br><br>
            <strong>Need access?</strong> Contact <a href="mailto:movr@mdausa.org" style="color: #2c5aa0;">movr@mdausa.org</a>
        </div>
        
        <input type="text" id="viewer-password" placeholder="Enter password for enhanced access" style="padding:8px 12px; border:1px solid #ccc; border-radius:4px; width:100%; margin-bottom:1em; font-size:14px;">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="unlock-btn" style="padding:12px 24px; background:#2c5aa0; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:14px; font-weight:bold; transition:background 0.2s;">
                Login
            </button>
            <button onclick="goBackToIndex()" style="padding:12px 24px; background:#666; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:14px; font-weight:bold; transition:background 0.2s;">
                Back to Home
            </button>
        </div>
        <div id="password-error" style="color:#d32f2f; margin-top:1em; font-weight:500;"></div>
        <div id="debug-info" style="margin-top:1em; font-size:12px; color:#666;"></div>
    </div>
    <div class="container" id="main-content">
        <div class="header">
            <div class="nav-links" style="margin-bottom: 15px;">
                <a href="vendor_mapping_viewer.html" style="color: #2c5aa0; text-decoration: none; margin-right: 20px; font-weight: 500; padding: 8px 16px; border-radius: 4px; border: 1px solid #2c5aa0;">Vendor Mapping →</a>
                <a href="index.html" style="color: #2c5aa0; text-decoration: none; margin-right: 20px; font-weight: 500; padding: 8px 16px; border-radius: 4px; border: 1px solid #2c5aa0;">Home</a>
                <div id="login-prompt-btn" style="float: right;">
                    <button onclick="showLoginOptions()" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
                        🔐 Login for Enhanced Access
                    </button>
                </div>
            </div>
            <h1>MDA MOVR Data Dictionary</h1>
            <p>Medical Advisory Review - Case Report Forms</p>
            
            <div class="stats" id="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalFields">0</div>
                    <div class="stat-label">Total Fields</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="dmdFields">0</div>
                    <div class="stat-label">DMD Fields</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="smaFields">0</div>
                    <div class="stat-label">SMA Fields</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="requiredFields">0</div>
                    <div class="stat-label">Required Fields</div>
                </div>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="formFilter">Filter by Form:</label>
                    <select id="formFilter">
                        <option value="">All Forms</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sectionFilter">Filter by Section:</label>
                    <select id="sectionFilter">
                        <option value="">All Sections</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="studyFilter">Study Type:</label>
                    <select id="studyFilter">
                        <option value="">All</option>
                        <option value="dmd">DMD Only</option>
                        <option value="sma">SMA Only</option>
                        <option value="both">Both DMD & SMA</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="requiredFilter">Field Type:</label>
                    <select id="requiredFilter">
                        <option value="">All Fields</option>
                        <option value="required">Required Only (*)</option>
                        <option value="optional">Optional Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Search:</label>
                    <input type="text" id="searchFilter" placeholder="Search display labels...">
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <h3>Forms</h3>
            <ul class="section-nav" id="formNav">
            </ul>
            
            <h3 style="margin-top: 20px;">Sections</h3>
            <ul class="section-nav" id="sectionNav">
            </ul>
        </div>
        
        <div class="main-content">
            <div class="submit-section">
                <div style="margin-bottom: 15px;">
                    <label for="customFileName" style="display: block; margin-bottom: 5px; font-weight: 500;">Custom Filename (optional):</label>
                    <input type="text" id="customFileName" placeholder="e.g., gene_therapy_review, advisory_meeting_1" 
                           style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 300px; font-size: 14px;">
                    <small style="display: block; color: #666; margin-top: 3px;">Leave blank for default "noname". Timestamp always included.</small>
                </div>
                <button class="load-btn" onclick="loadPriorities()">Load Existing Priorities</button>
                <button class="submit-btn" onclick="savePriorities()">Save Field Priorities</button>
                <div id="statusMessage" class="status-message"></div>
            </div>
            
            <div id="dataContainer">
                Loading data dictionary...
            </div>
        </div>
    </div>

    <script type="module">
        // Import session management
        import('../js/session-manager.js').then(module => {
            window.sessionManager = module;
            initializePage();
        }).catch(e => {
            console.error('Failed to load session manager:', e);
            // Still show page content 
            initializePage();
        });

        // Initialize page access control
        function initializePage() {
            // Data dictionary is always accessible, but show login prompt for enhanced features
            const session = window.getActiveSession ? window.getActiveSession() : null;
            if (session) {
                // User is logged in, show session indicator and hide login prompt
                if (window.addSessionIndicator) {
                    window.addSessionIndicator(session);
                }
                // Hide the login prompt button and show enhanced features
                document.getElementById('login-prompt-btn').style.display = 'none';
                showEnhancedFeatures();
            } else {
                // User not logged in, show basic features only
                hideEnhancedFeatures();
            }
            
            // Always load the data dictionary (no authentication required)
            loadData();
        }

        function showLoginOptions() {
            if (window.showLoginPrompt) {
                window.showLoginPrompt(window.location.pathname, 'Login to access enhanced features and additional MOVR viewers.');
            } else {
                // Fallback
                document.getElementById('password-lock').style.display = 'block';
            }
        }

        function goBackToIndex() {
            window.location.href = '../index.html';
        }

        function showEnhancedFeatures() {
            // Show enhanced features for logged-in users
            const submitSection = document.querySelector('.submit-section');
            if (submitSection) {
                submitSection.style.display = 'block';
            }
        }

        function hideEnhancedFeatures() {
            // Hide enhanced features for non-logged-in users
            const submitSection = document.querySelector('.submit-section');
            if (submitSection) {
                submitSection.style.display = 'none';
            }
        }

        // Make functions globally available
        window.showLoginOptions = showLoginOptions;
        window.goBackToIndex = goBackToIndex;
        window.showEnhancedFeatures = showEnhancedFeatures;
        window.hideEnhancedFeatures = hideEnhancedFeatures;

        let data = [];
        let filteredData = [];
        let fieldPriorities = {}; // Store priority selections

        // Load the data dictionary
        async function loadData() {
            try {
                const response = await fetch('./data_dictionary.json');
                data = await response.json();
                processData();
                renderData();
                updateStats();
            } catch (error) {
                document.getElementById('dataContainer').innerHTML = 
                    '<p>Error loading data dictionary. Please ensure data_dictionary.json is in the same directory.</p>';
                console.error('Error loading data:', error);
            }
        }

        function processData() {
            // Populate form filter dropdown
            const forms = [...new Set(data.map(item => item['File/Form']).filter(Boolean))].sort();
            
            const formFilter = document.getElementById('formFilter');
            
            forms.forEach(form => {
                const option = document.createElement('option');
                option.value = form;
                option.textContent = form;
                formFilter.appendChild(option);
            });
            
            // Initialize section filter (will be populated when form is selected)
            updateSectionFilter();
            
            // Build navigation
            buildNavigation(forms);
            
            filteredData = data;
        }

        function updateSectionFilter() {
            const formFilter = document.getElementById('formFilter').value;
            const sectionFilter = document.getElementById('sectionFilter');
            
            // Clear existing options except "All Sections"
            sectionFilter.innerHTML = '<option value="">All Sections</option>';
            
            // Get sections for the selected form (or all sections if no form selected)
            let sectionsToShow;
            if (formFilter) {
                sectionsToShow = [...new Set(data
                    .filter(item => item['File/Form'] === formFilter)
                    .map(item => item['SECTION'])
                    .filter(Boolean)
                )].sort();
            } else {
                sectionsToShow = [...new Set(data.map(item => item['SECTION']).filter(Boolean))].sort();
            }
            
            sectionsToShow.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionFilter.appendChild(option);
            });
        }

        function buildNavigation(forms) {
            // Build form navigation
            const formNav = document.getElementById('formNav');
            forms.forEach(form => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#form-${form.replace(/[^a-zA-Z0-9]/g, '-')}`;
                a.textContent = form;
                li.appendChild(a);
                formNav.appendChild(li);
            });
            
            // Build section navigation
            const sections = [...new Set(data.map(item => item['SECTION']).filter(Boolean))].sort();
            const sectionNav = document.getElementById('sectionNav');
            sections.forEach(section => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#section-${section.replace(/[^a-zA-Z0-9]/g, '-')}`;
                a.textContent = section;
                a.title = section; // Full text on hover for long names
                li.appendChild(a);
                sectionNav.appendChild(li);
            });
        }

        function applyFilters() {
            const formFilter = document.getElementById('formFilter').value;
            const sectionFilter = document.getElementById('sectionFilter').value;
            const studyFilter = document.getElementById('studyFilter').value;
            const requiredFilter = document.getElementById('requiredFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredData = data.filter(item => {
                if (formFilter && item['File/Form'] !== formFilter) return false;
                if (sectionFilter && item['SECTION'] !== sectionFilter) return false;
                if (searchFilter && !item['Display Label'].toLowerCase().includes(searchFilter)) return false;
                
                if (studyFilter === 'dmd' && !item['DMD']) return false;
                if (studyFilter === 'sma' && !item['SMA']) return false;
                if (studyFilter === 'both' && (!item['DMD'] || !item['SMA'])) return false;
                
                // Required field filter
                const isRequired = item['Display Label'] && item['Display Label'].includes('*');
                if (requiredFilter === 'required' && !isRequired) return false;
                if (requiredFilter === 'optional' && isRequired) return false;
                
                return true;
            });
            
            renderData();
            updateStats();
        }

        function onFormFilterChange() {
            // Update section filter options based on selected form
            updateSectionFilter();
            // Clear section filter selection since options changed
            document.getElementById('sectionFilter').value = '';
            // Apply filters
            applyFilters();
        }

        function renderData() {
            const container = document.getElementById('dataContainer');
            
            // Group by form, then by section
            const grouped = {};
            filteredData.forEach(item => {
                const form = item['File/Form'] || 'Unknown Form';
                const section = item['SECTION'] || 'No Section Specified';
                
                if (!grouped[form]) grouped[form] = {};
                if (!grouped[form][section]) grouped[form][section] = [];
                
                grouped[form][section].push(item);
            });
            
            let html = '';
            
            // Sort forms, but put "No Section Specified" sections at the end
            Object.keys(grouped).sort().forEach(form => {
                html += `
                    <div class="form-section" id="form-${form.replace(/[^a-zA-Z0-9]/g, '-')}">
                        <div class="form-header">${form}</div>
                `;
                
                // Sort sections, putting "No Section Specified" at the end
                const sections = Object.keys(grouped[form]);
                const namedSections = sections.filter(s => s !== 'No Section Specified').sort();
                const unnamedSections = sections.filter(s => s === 'No Section Specified');
                const sortedSections = [...namedSections, ...unnamedSections];
                
                sortedSections.forEach(section => {
                    const fields = grouped[form][section];
                    const sectionId = section !== 'No Section Specified' ? 
                        `section-${section.replace(/[^a-zA-Z0-9]/g, '-')}` : '';
                    
                    html += `
                        <div class="section-group" ${sectionId ? `id="${sectionId}"` : ''}>
                            <div class="section-title">${section} (${fields.length} fields)</div>
                    `;
                    
                    fields.forEach(field => {
                        const tags = [];
                        if (field['DMD']) tags.push('<span class="tag dmd">DMD</span>');
                        if (field['SMA']) tags.push('<span class="tag sma">SMA</span>');
                        if (field['Display Label'] && field['Display Label'].includes('*')) {
                            tags.push('<span class="tag required">REQUIRED</span>');
                        }
                        
                        const fieldKey = `${field['File/Form']}_${field['Field Name']}`;
                        const currentPriority = fieldPriorities[fieldKey] || '';
                        const priorityClass = currentPriority ? `priority-${currentPriority}` : '';
                        
                        html += `
                            <div class="field-item ${priorityClass}">
                                <div class="field-header">
                                    <div class="display-label">${field['Display Label'] || 'No label'}</div>
                                    <div class="tags">${tags.join('')}</div>
                                </div>
                                <div class="field-details">
                                    <strong>Field Name:</strong> <span class="field-name">${field['Field Name'] || 'N/A'}</span><br>
                                    <strong>Type:</strong> ${field['Field Type'] || 'N/A'}<br>
                                    ${field['Description'] ? `<strong>Description:</strong> ${field['Description']}<br>` : ''}
                                    ${field['Numeric Ranges'] ? `<strong>Range:</strong> ${field['Numeric Ranges']}<br>` : ''}
                                </div>
                                <div class="priority-control">
                                    <div class="priority-label">Priority Level:</div>
                                    <select class="priority-select" onchange="updatePriority('${fieldKey}', this.value)" data-field-key="${fieldKey}">
                                        <option value="">Not Set</option>
                                        <option value="high" ${currentPriority === 'high' ? 'selected' : ''}>High</option>
                                        <option value="medium" ${currentPriority === 'medium' ? 'selected' : ''}>Medium</option>
                                        <option value="low" ${currentPriority === 'low' ? 'selected' : ''}>Low</option>
                                        <option value="irrelevant" ${currentPriority === 'irrelevant' ? 'selected' : ''}>Irrelevant</option>
                                        <option value="test" ${currentPriority === 'test' ? 'selected' : ''}>Test (White)</option>
                                    </select>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html || '<p>No data matches the current filters.</p>';
        }

        function updateStats() {
            const total = filteredData.length;
            const dmd = filteredData.filter(item => item['DMD']).length;
            const sma = filteredData.filter(item => item['SMA']).length;
            const required = filteredData.filter(item => item['Display Label'] && item['Display Label'].includes('*')).length;
            
            document.getElementById('totalFields').textContent = total;
            document.getElementById('dmdFields').textContent = dmd;
            document.getElementById('smaFields').textContent = sma;
            document.getElementById('requiredFields').textContent = required;
        }

        // Event listeners
        document.getElementById('formFilter').addEventListener('change', onFormFilterChange);
        document.getElementById('sectionFilter').addEventListener('change', applyFilters);
        document.getElementById('studyFilter').addEventListener('change', applyFilters);
        document.getElementById('requiredFilter').addEventListener('change', applyFilters);
        document.getElementById('searchFilter').addEventListener('input', applyFilters);

        // Priority management functions
        function updatePriority(fieldKey, priority) {
            if (priority) {
                fieldPriorities[fieldKey] = priority;
            } else {
                delete fieldPriorities[fieldKey];
            }
            
            // Update visual indicator by re-rendering
            renderData();
            showStatus(`Updated priority for ${fieldKey}`, 'success');
        }

        function savePriorities() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            const timeStr = today.toISOString().replace(/[:.]/g, '-').slice(0, -5); // Clean timestamp for filename
            
            // Get custom filename or use default
            const customName = document.getElementById('customFileName').value.trim();
            const baseName = customName || 'noname';
            
            // Clean the custom name for filename use
            const cleanName = baseName.replace(/[^a-zA-Z0-9_-]/g, '_');
            
            const priorityData = {
                session_name: customName || 'Default Session',
                session_date: dateStr,
                session_timestamp: today.toISOString(),
                total_fields_prioritized: Object.keys(fieldPriorities).length,
                priorities: fieldPriorities
            };
            
            const dataStr = JSON.stringify(priorityData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const filename = `${dateStr}_${timeStr}_${cleanName}_field_priorities.json`;
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`Saved ${Object.keys(fieldPriorities).length} field priorities to ${filename}`, 'success');
        }

        function loadPriorities() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.priorities) {
                                fieldPriorities = data.priorities;
                                renderData();
                                showStatus(`Loaded ${Object.keys(fieldPriorities).length} field priorities from ${file.name}`, 'success');
                            } else {
                                showStatus('Invalid priority file format', 'error');
                            }
                        } catch (error) {
                            showStatus('Error reading priority file: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // Load data on page load if unlocked
        function tryLoadData() {
            if (passwordChecked && !passwordExpired) {
                loadData();
            }
        }
        
        // Backup global function (keep for compatibility)
        window.handleUnlock = function() {
            console.log('Global handleUnlock called!');
            document.getElementById('debug-info').textContent = 'Global function called...';
            checkPassword('dictionary');
            tryLoadData();
        };
    </script>

    <!-- Session Authentication Check -->
    <script type="module">
        // Import session management
        import { SessionManager } from '../js/session-manager.js';
        
        // Initialize session manager
        const sessionManager = new SessionManager();
        
        // Check authentication on page load
        function checkAuthentication() {
            const user = sessionManager.getCurrentUser();
            const loginWall = document.getElementById('login-wall');
            const mainContent = document.querySelector('.container');
            
            if (!user) {
                // Not logged in - show login wall
                loginWall.style.display = 'flex';
                if (mainContent) {
                    mainContent.style.display = 'none';
                }
            } else {
                // Logged in - hide login wall and show content
                loginWall.style.display = 'none';
                if (mainContent) {
                    mainContent.style.display = 'block';
                }
                
                // Try to load data if user has sufficient access
                if (window.tryLoadData) {
                    window.tryLoadData();
                }
            }
        }
        
        // Function to recheck authentication (called by button)
        window.checkAuthAgain = function() {
            checkAuthentication();
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthentication();
        });
        
        // Update when session changes (e.g., from other tabs)
        window.addEventListener('storage', (e) => {
            if (e.key === 'movr_session') {
                checkAuthentication();
            }
        });
    </script>
</body>
</html>